var orgchart={},data={};const anniversaries=[],tenures=[],chain=[],splash="ceo",separator=",",maxline=20,txt="click card status bar to select the person...",charts={"@loc":p=>p.Location,"@role":p=>"TRUE"==p.IsManager?"Manager":"IC","@title":p=>p.Title,"@status":p=>p.Status,"@type":p=>p.Type,"@country":p=>p.Country,"@state":p=>p.State,"@l9":p=>p.State},level_1=[],level_2=[],level_3=[],lists={$l7:{name:"<L1> People",list:level_1},$l8:{name:"<L2> People",list:level_2},$l9:{name:"<L3> People",list:level_3},$yday:{name:"Anniversaries",list:anniversaries}};function cl(){$("#list").text(txt)}function sl(){const list=$("#list").text();list!=txt&&hash(list)}function cube(node,parent,p,rl,role,noz){const c_color=["#FF4500","#000080","#228B22"],c_bg=["#fee","#efe","#eef"],c_leaf=[!1,!1,!0],bg=c_bg[role],leaf=rl&&c_leaf[role],focus=1==role;let color=c_color[role];var meta="IC";if(p.Alias in data.directs){var drs=data.directs[p.Alias].length;if(meta="+"+drs+" directs",p.Alias in data.rollups){var count=data.rollups[p.Alias];count>0&&count>drs&&(meta+=" +"+count+" rollups")}}if("T"in p){var unix=p.T;if(unix>0){var yrs=((Date.now()-1e3*unix)/1e3/3600/24/365).toFixed(1);yrs>0&&(meta+=" > "+yrs+"yrs")}}p.Status&&"Active"!==p.Status&&("Terminated"===p.Status&&(color="grey"),meta+=" ("+p.Status+")");var name=p.Name;name&&(name=name.trunc(20)),level_3.indexOf(p.Alias)>=0?name+=" (E3)":level_2.indexOf(p.Alias)>=0?name+=" (E2)":level_1.indexOf(p.Alias)>=0&&(name+=" (E1)");var title=p.Title||"";title&&!focus&&(title=title.trunc(20)),title=title.padEnd(20," ");var photo="images/ph.png";p.P&&"0"!==p.P&&(photo=p.P);var depart=p.Department||"~free";focus||(depart=depart.trunc(20));const lines=[name,title,depart,p.Location],since=p.Since||"unknown",index=tenures.indexOf(since),pct=Math.floor(100*index/tenures.length);if(lines.push(`[tenure > ${pct}%] ~${since}`),!noz&&p.Z)if(focus)lines.push(`"${p.Z.trunc(20)}"`);else{const sun=String.fromCharCode(9728);meta=`${sun} ${meta}`}if(-1!==anniversaries.indexOf(p.Alias)){const badge=String.fromCharCode(9971);let count=(new Date).getFullYear()-new Date(p.Since).getFullYear();count&&(meta=`${new Array(count+1).join(badge)} ${meta}`)}return new Cube(node,parent,{n:p.Alias,c:color,b:bg,i:{src:photo,text:lines},m:meta,l:leaf})}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+"...":this};class Node{constructor(person){this.person=person,this.children=[],this.folk=!1,this.pid=0}add(node){this.children.push(node)}focus(){this.folk=!0}}function chainUsers(users){if(1==users.length)return treeChain(users[0]);for(var map={},root=null,i=0;i<users.length;++i){var alias=users[i],cur=data.people[data.index[alias]];if(alias in map)map[alias].focus();else{var node=new Node(cur);for(map[alias]=node;cur.Boss in data.index;){var bid=data.index[cur.Boss],m=data.people[bid];if(m.Alias==cur.Alias)break;if(m.Alias in map){var joint=map[m.Alias];joint.focus(),joint.add(node);break}var mNode=new Node(m);map[m.Alias]=mNode,mNode.add(node),node=mNode,cur=m}null===root&&(root=node)}}return root}function treeChain(user){var idx=data.index[user],me=data.people[idx],root=new Node(me);if(root.focus(),me.Alias in data.directs)for(var drs=data.directs[me.Alias],k=0;k<drs.length;++k)root.add(new Node(data.people[data.index[drs[k]]]));for(var cur=me;cur.Boss in data.index;){var bid=data.index[cur.Boss],m=data.people[bid];if(m.Alias==cur.Alias)break;var node=new Node(m);node.add(root),root=node,cur=m}return root}function paint(root,rl,noz){orgchart=new OrgChart("chart");for(var k=1,role=0,queue=[root];queue.length>0;){var cur=queue[queue.length-1];chain[k]=cur.person,queue.pop(),cur.folk?role=1:1==role&&(role=2),orgchart.Push(cube(k,cur.pid,cur.person,rl,role,noz));for(var row=4,i=0;i<cur.children.length;++i){var n=cur.children[i];n.pid=i>=4?k+i-4+1:k,queue.unshift(n)}k++}orgchart.NodeClick=function(id){hash(chain[id].Alias)},orgchart.NodeSearch=function(id){let alias=chain[id].Alias;const value=$("#list").text();value!=txt&&(alias=`${value},${alias}`),$("#list").text(alias)},orgchart.Draw()}function pie(data,title){var c=(orgchart=new OrgChart("chart")).Canvas,size=window.innerWidth;c.width=size*dpr,c.height=size,orgchart.Pie(data,!0,title)}function chart(key){for(var distr={},count=0,fetch=charts[key],i=0;i<data.people.length;++i){var loc=fetch(data.people[i]);loc&&"undefined"!==loc&&(loc in distr?distr[loc]+=1:(distr[loc]=1,count++))}var top=6;if(count>6){var sortable=[];for(var k in distr)sortable.push([k,distr[k]]);sortable.sort((function(a,b){return b[1]-a[1]})),distr=sortable.slice(0,6).reduce((function(p,c){return p[c[0]]=c[1],p}),{})}pie(distr,"DISTRIBUTION BY "+key)}function draw(users){if(1==users.length){var key=users[0];if(key in charts)return chart(key);if(key in lists){const presetList=lists[key];return preset(presetList.name,presetList.list.filter(e=>e in data.index))}}var root;paint(chainUsers(users),1==users.length)}function drawUrl(){var h=location.hash.substr(1);0!==h.indexOf("?")?draw(getHash()):srch(h.substr(1))}function getHash(){if(location.hash&&data.index){var alias=location.hash.substr(1);if(alias in data.index)return[alias];if(alias.indexOf(",")>-1){var list=alias.trim().split(/\s*,\s*/).filter(e=>e.trim()in data.index);if(list&&list.length>0)return list}if(alias in charts||alias in lists)return[alias]}return["ceo"]}function hash(key){window.location.hash="#"+key}function clr(input){input.value=""}function go(ele){if("Enter"===event.key){var key=ele.value;if(!key)return;if(key in data.index||key.indexOf(",")>-1)return hash(key.replace(/\s/g,"")),void clr(ele);hash("?"+key),clr(ele)}}function srch(key){key=decodeURI(key).trim();var max=100,search={Alias:"#",Name:"",Title:"Search Results",Phone:"",Location:""},root=new Node(search);root.focus();for(var regex=key.split(" ").map(e=>new RegExp(e,"i")),rsize=regex.length,results=0,i=0;i<data.people.length;++i){var p=data.people[i],res=-1;if(1===rsize&&(res=p.Alias.search(regex)),-1===res&&p.Name){for(var b=!0,k=0;k<rsize;++k)b=b&&p.Name.search(regex[k])>=0;res=b?0:-1}if(res>=0&&(root.add(new Node(p)),results++>=100))break}if(results>0){var sr="Found People: "+results;console.log(sr),search.Location=sr,paint(root,!0,!0)}}function preset(name,users){var top={Alias:"#",Name:"public list",Title:name,Phone:"",Location:`total ${users.length} people.`},root=new Node(top);root.focus(),users.map(e=>root.add(new Node(data.people[data.index[e]]))),paint(root,!0,!0)}function copy(){const canvas=orgchart.Canvas;canvas&&navigator.clipboard&&canvas.toBlob(blob=>{const item=new ClipboardItem({"image/png":blob});navigator.clipboard.write([item]),alert("Copied - you can paste the image somewhere now!")})}$(document).ready((function(){cl(),Utility.SearchUI="oc",Utility.Font="7.7pt Sans-Serif",Utility.ImageDimen={width:50,height:50},$.getJSON("scripts/data.json.gz",(function(d){data=d;const today=new Date;for(var i=0;i<data.people.length;++i){var p=data.people[i];if(p.Since){tenures.push(p.Since);const d=new Date(p.Since);d.getMonth()==today.getMonth()&&d.getDate()==today.getDate()&&anniversaries.push(p.Alias)}}const since2time=x=>new Date(x.replace(/(\d{2})\/(\d{2})\/(\d{2})/,"20$3-$1-$2")).getTime();tenures.sort((a,b)=>since2time(b)-since2time(a)),drawUrl()})),window.onhashchange=function(){drawUrl()},$.getJSON("user",u=>{u&&u.user&&($("#user").text(u.user),0==location.hash.length&&hash(u.user))})}));