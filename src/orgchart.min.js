var Utility=new function(){this.IsSolid=function(obj){return!this.IsNull(obj)&&("boolean"!=typeof obj||obj)},this.IsFunction=function(obj){return!this.IsNull(obj)&&"function"==typeof obj},this.IsNull=function(obj){return null==obj},this.Each=function(arr,Func){for(var i=0;i<arr.length;++i){var result=Func(arr[i],i);if(Utility.IsSolid(result))return result}return null},this.DrawCircle=function(canvas,x,y,r,fill,color){canvas.fillStyle=fill,canvas.beginPath(),canvas.arc(x,y,r,0,2*Math.PI,!1),canvas.strokeStyle=color,canvas.stroke()},this.DrawConnection=function(canvas,start,end){this.DrawLine(canvas,start,end,Utility.LineWidth,Utility.LineColor)},this.DrawSeperator=function(canvas,start,end){this.DrawLine(canvas,start,end,.5,Utility.CommandColor)},this.DrawLine=function(canvas,start,end,lw,color){canvas.beginPath(),canvas.lineWidth=lw,canvas.strokeStyle=color,canvas.moveTo(start.x,start.y),canvas.lineTo(end.x,end.y),canvas.stroke()},this.DrawRect=function(canvas,position,dim){canvas.strokeStyle=Utility.CubeBd,canvas.fillStyle=Utility.CubeBg;var lw=Utility.LineWidth;canvas.lineWidth=lw,canvas.fillRect(position.x+lw,position.y+lw,dim.width-2*lw,dim.height-2*lw),canvas.strokeRect(position.x,position.y,dim.width,dim.height)},this.DrawText=function(canvas,position,text,color){canvas.fillStyle=color,canvas.fillText(text,position.x,position.y)},this.SearchClickedOne=function(node,x,y){return node.ClickMe(x,y)?node:this.Each(node.Children,function(item){return Utility.SearchClickedOne(item,x,y)})},this.MaxCubeWidth=120,this.MinCubeWidth=50,this.MinCubeHeight=50,this.MaxCubeHeight=150,this.LevelGap=40,this.CubeGap=10,this.TextMargin=4,this.LineHeight=10,this.CubeBg="rgb(237, 247, 255)",this.CubeBd="rgb(181, 217, 234)",this.LineColor="rgb(51,136,221)",this.CommandColor="gray",this.Font="10px Sans-Serif",this.SearchUI="search",this.LineWidth=2,this.ImageDimen={width:70,height:70}};function Cube(id,parent,data){if(null==id||null==parent||null==data)throw"ID, Parent, Name are required field for a cube";this.Id=id,this.ParentId=parent,this.Name=data.n,this.Color=data.c,this.Image=data.i,!Utility.IsNull(this.Image)&&Utility.IsNull(this.Image.dim)&&(this.Image.dim=Utility.ImageDimen),this.Level=0,this.LevelMaxNodes=1,this.Depth=0,this.TotalHeight=0,this.Size=1,this.Dimen={width:Utility.MinCubeWidth,height:Utility.TextMargin},this.Span=0,this.Lines=[],this.Children=[],this.Position={x:Utility.CubeGap,y:Utility.LevelGap},this.SeperatorY=999999,this.Context=null,this.OC=null}function OrgChart(cid){this.CanvasId=cid,this.Canvas=document.getElementById(cid),this.Canvas2D=this.Canvas.getContext("2d"),this.Canvas2D.font=Utility.Font,this.Cubes=[],this.LevelHeight=[],this.Final=null,this.NodeClick=null,this.NodeSearch=null;var oc=this;this.Canvas.onmousemove=function(e){if(Utility.IsFunction(oc.NodeClick)||Utility.IsFunction(oc.NodeSearch)){null==e&&(e=window.event);var cube=oc.GetClickedCube(e.offsetX,e.offsetY);Utility.IsNull(cube)?document.body.style.cursor="":document.body.style.cursor="pointer"}},this.Canvas.onclick=function(e){if(Utility.IsFunction(oc.NodeClick)||Utility.IsFunction(oc.NodeSearch)){null==e&&(e=window.event);var cube=oc.GetClickedCube(e.offsetX,e.offsetY);Utility.IsNull(cube)||(cube.IsInSearch(e.offsetX,e.offsetY)?oc.NodeSearch(cube.Id):Utility.IsFunction(oc.NodeClick)&&oc.NodeClick(cube.Id))}}}Cube.prototype.HasSearch=function(){return!Utility.IsNull(this.OC.NodeSearch)},Cube.prototype.IsInSearch=function(x,y){return this.HasSearch()&&y>this.SeperatorY},Cube.prototype.AddChild=function(cube){this.Children.push(cube)},Cube.prototype.RefreshLevel=function(){var level=this.Level;return Utility.Each(this.Children,function(node){return node.Level=level+1,node.RefreshLevel()})},Cube.prototype.Count=function(dict){Utility.IsNull(dict[this.Level])?dict[this.Level]=1:dict[this.Level]+=1,Utility.Each(this.Children,function(item){item.Count(dict)})},Cube.prototype.SetLevelInfo=function(){var dict={};this.Count(dict);var max=1,c=1;for(var item in dict)c++,dict[item]>max&&(max=dict[item]);this.LevelMaxNodes=max,this.Depth=c},Cube.prototype.RealSpan=function(){return Math.max(this.Span,this.Dimen.width)},Cube.prototype.ComputeSpan=function(){this.ComputeDimension();var span=0,size=1;if(this.Children.length>0){span=(this.Children.length-1)*Utility.CubeGap;for(var i=0;i<this.Children.length;++i)span+=this.Children[i].ComputeSpan(),size+=this.Children[i].Size}return this.Size=size,this.Span=span,this.RealSpan()},Cube.prototype.GetTextWidth=function(text){return this.Context.measureText(text).width+2*Utility.TextMargin},Cube.prototype.ComputeDimension=function(){var textWidth;if(Utility.IsNull(this.Image))if(this.GetTextWidth(this.Name)<Utility.MaxCubeWidth)this.AddLine(this.Name);else{for(var words=this.Name.split(" "),line=words[0],i=1;i<words.length;++i)this.GetTextWidth(line+" "+words[i])>=Utility.MaxCubeWidth?(this.AddLine(line),line=words[i]):line=line+" "+words[i];line.length>0&&this.AddLine(line)}else if(this.Dimen.width=this.Image.dim.width+2*Utility.TextMargin,this.Dimen.height=this.Image.dim.height+2*Utility.TextMargin,!Utility.IsNull(this.Image.text)){for(var text=this.Image.text,mw=0,mh=text.length*Utility.LineHeight+(text.length+1)*Utility.TextMargin,i=0;i<text.length;++i){this.Lines.push(text[i]);var lw=this.GetTextWidth(text[i]);lw>mw&&(mw=lw)}this.Dimen.width+=mw+Utility.TextMargin,mh>this.Dimen.height&&(this.Dimen.height=mh)}this.HasSearch()&&(this.Dimen.height+=2*Utility.TextMargin+Utility.LineHeight),this.Dimen.height<Utility.MinCubeHeight&&(this.Dimen.height=Utility.MinCubeHeight)},Cube.prototype.AddLine=function(line){this.Lines.push(line);var textWidth=this.GetTextWidth(line);textWidth>this.Dimen.width&&(this.Dimen.width=textWidth),this.Dimen.height+=Utility.LineHeight+Utility.TextMargin},Cube.prototype.FindNode=function(id){return this.Id==id?this:Utility.Each(this.Children,function(node,idx){return node.FindNode(id)})},Cube.prototype.ClickMe=function(x,y){return x>this.Position.x&&x<this.Position.x+this.Dimen.width&&y>this.Position.y&&y<this.Position.y+this.Dimen.height},Cube.prototype.Draw=function(){Utility.DrawRect(this.Context,this.Position,this.Dimen);var sx=this.Position.x+Utility.TextMargin,sy=this.Position.y+ +Utility.TextMargin+Utility.LineHeight;if(!Utility.IsNull(this.Image)){var img=new Image;img.src=this.Image.src,img.cube=this,img.onload=function(){window.setTimeout("void()","1000");var dim=this.cube.Image.dim;Utility.IsNull(dim)&&(dim=Utility.ImageDimen),this.cube.Context.drawImage(this,this.cube.Position.x+Utility.TextMargin,this.cube.Position.y+Utility.TextMargin,dim.width,dim.height)},sx+=this.Image.dim.width+Utility.TextMargin}for(var i=0;i<this.Lines.length;++i)Utility.DrawText(this.Context,{x:sx,y:sy},this.Lines[i],this.Color),sy+=Utility.TextMargin+Utility.LineHeight;if(this.HasSearch()&&(this.SeperatorY=this.Position.y+this.Dimen.height-2*Utility.TextMargin-Utility.LineHeight,Utility.DrawSeperator(this.Context,{x:this.Position.x+Utility.TextMargin,y:this.SeperatorY},{x:this.Position.x+this.Dimen.width-Utility.TextMargin,y:this.SeperatorY}),Utility.DrawText(this.Context,{x:this.Position.x+this.Dimen.width-Utility.TextMargin-this.GetTextWidth(Utility.SearchUI),y:this.SeperatorY+Utility.LineHeight+Utility.TextMargin},Utility.SearchUI,Utility.CommandColor)),Utility.Each(this.Children,function(node){return node.Draw()}),this.Children.length>0){var start={x:this.Position.x+this.Dimen.width/2,y:this.Position.y+this.Dimen.height};Utility.DrawConnection(this.Context,start,{x:start.x,y:start.y+Utility.LevelGap/2});for(var i=0;i<this.Children.length;++i){var s={x:this.Children[i].Position.x+this.Children[i].Dimen.width/2,y:this.Children[i].Position.y};Utility.DrawConnection(this.Context,s,{x:s.x,y:s.y-Utility.LevelGap/2})}if(this.Children.length>1){var first=this.Children[0],ss={x:first.Position.x+first.Dimen.width/2,y:first.Position.y-Utility.LevelGap/2},last=this.Children[this.Children.length-1],ee={x:last.Position.x+last.Dimen.width/2,y:last.Position.y-Utility.LevelGap/2};Utility.DrawConnection(this.Context,ss,ee)}}return null},OrgChart.prototype.GetClickedCube=function(x,y){return Utility.IsNull(this.Final)?null:Utility.SearchClickedOne(this.Final,x,y)},OrgChart.prototype.Push=function(cube){for(cube.Context=this.Canvas2D,cube.OC=this;;){var sonIdx=Utility.Each(this.Cubes,function(item,idx){if(item.ParentId==cube.Id)return idx});if(Utility.IsNull(sonIdx))break;var item=this.Cubes.splice(sonIdx,1)[0];cube.AddChild(item)}var parent=Utility.Each(this.Cubes,function(item,idx){return item.FindNode(cube.ParentId)});Utility.IsNull(parent)?this.Cubes.push(cube):parent.AddChild(cube)},OrgChart.prototype.Layout=function(root){root.RefreshLevel(),root.SetLevelInfo(),Utility.MaxCubeWidth=root.Context.canvas.width/root.LevelMaxNodes,root.ComputeSpan(),this.LevelHeight.length=0;var q=[];for(q.push(root),this.LevelHeight.push(root.Dimen.height),root.Position.x=root.RealSpan()/2-root.Dimen.width/2;q.length>0;){var top=q.shift();top.Level==this.LevelHeight.length-1?top.Dimen.height>this.LevelHeight[this.LevelHeight.length-1]&&(this.LevelHeight[this.LevelHeight.length-1]=top.Dimen.height):this.LevelHeight.push(top.Dimen.height);var cx=top.Position.x+top.Dimen.width/2-top.RealSpan()/2;top.Dimen.width>top.Span&&(cx+=(top.Dimen.width-top.Span)/2);for(var cy=top.Position.y+top.Dimen.height+Utility.LevelGap,i=0;i<top.Children.length;++i){var child=top.Children[i];child.Position.x=cx+child.RealSpan()/2-child.Dimen.width/2,top.Children.length,child.Position.y=cy,cx+=child.RealSpan()+Utility.CubeGap,q.push(child)}}root.TotalHeight=Utility.LevelGap;for(var i=0;i<this.LevelHeight.length;++i)root.TotalHeight+=this.LevelHeight[i]+Utility.LevelGap},OrgChart.prototype.Draw=function(){this.Canvas2D.clearRect(0,0,this.Canvas.width,this.Canvas.height);var oc=this;if(Utility.Each(this.Cubes,function(root){return oc.Layout(root),null}),this.Cubes.length>0){this.Final=this.Cubes[0];for(var i=1;i<this.Cubes.length;++i)this.Cubes[i].Size>this.Final.Size&&(this.Final=this.Cubes[i]);var dpr=window.devicePixelRatio||1;this.Canvas.width=dpr*(this.Final.RealSpan()+2*Utility.CubeGap),this.Canvas.height=dpr*this.Final.TotalHeight,this.Canvas2D.scale(dpr,dpr),this.Final.Draw()}};